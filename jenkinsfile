pipeline {

agent any

tools {
nodejs 'Nodejs' 
}
 
 stages{


stage('Installing dependencies') {
            steps {
                
                sh  'npm install --no-audit'
 
                
            }

            
        }

   stage('Dependency scanning') {
            steps {
                
        catchError(message: 'error skipped', stageResult: 'SUCCESS') {
                sh  '''
                  npm audit --audit-level=critical
                   echo $?
               '''
        }
               
 
                
            }
        }



stage('Unit test') {

            steps {
withCredentials([usernamePassword(credentialsId: 'mongodbcred', passwordVariable: 'MONGO_PASSWORD', usernameVariable: 'MONGO_USERNAME')]) {
    sh  'npm test'
}

junit allowEmptyResults: true, stdioRetention: '', testResults: 'test-results.xml'
}

                 }

stage('Build Image'){
 steps{

    sh 'docker build -t anandhabadmanaban/solar-system-nodejs:$GIT_COMMIT .'
 }



                 }


                      }


}






